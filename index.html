<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEP Timetable Navigator (Phase 1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-color: #0d9488; /* Teal */
            --primary-hover: #0f766e;
            --secondary-color: #f0dfa;
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: var(--text-primary);
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
        }
        .hidden { display: none; }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .nav-item:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        .nav-item.active {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }
        .timetable-slot {
            background-color: #e0f2f1;
            border: 1px solid #b2dfdb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            min-height: 60px;
        }
        .timetable-slot.faded {
            background-color: #f0f2f5;
            border-color: #e2e8f0;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Page -->
    <div id="login-container" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md">
            <div id="role-selection-view" class="card p-8">
                <div class="flex flex-col items-center mb-6">
                    <i data-lucide="calendar-check" class="h-12 w-12 text-teal-600 bg-teal-50 p-2 rounded-lg"></i>
                    <h1 class="text-2xl font-bold text-gray-800 mt-4">NEP Timetable Navigator</h1>
                    <p class="text-gray-500">First, please select your role.</p>
                </div>
                <div class="space-y-3">
                    <button data-role="Admin" class="role-btn w-full btn btn-primary">I am an Admin</button>
                    <button data-role="Teacher" class="role-btn w-full btn btn-primary">I am a Teacher</button>
                    <button data-role="Student" class="role-btn w-full btn btn-primary">I am a Student</button>
                </div>
            </div>
            <div id="login-form-view" class="hidden card p-8 relative">
                <div class="flex items-center mb-6">
                    <button id="back-to-role-btn" class="text-gray-500 hover:text-gray-800 mr-4"><i data-lucide="arrow-left" class="h-6 w-6"></i></button>
                    <h2 id="login-title" class="text-2xl font-bold text-gray-800">Login</h2>
                </div>
                <form id="login-form">
                    <div id="login-error" class="hidden mb-4 p-3 text-sm text-red-700 bg-red-100 rounded-md">Invalid credentials.</div>
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" value="password">
                        </div>
                        <button type="submit" class="w-full btn btn-primary">Sign In</button>
                    </div>
                    <p class="text-xs text-center text-gray-500 mt-4">For this prototype, the password is 'password'.</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="hidden h-screen flex-col">
        <header class="bg-white border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center justify-between h-16 px-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="calendar-check" class="h-8 w-8 text-teal-600"></i>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">Timetable Navigator</h1>
                        <p class="text-xs text-gray-500">Phase 1: Basic Generator</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="return-to-admin-container" class="hidden">
                        <button id="return-to-admin-btn" class="btn bg-yellow-100 text-yellow-800 hover:bg-yellow-200">
                            <i data-lucide="shield" class="mr-2 h-5 w-5"></i>Return to Admin View
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-700" id="user-email"></p>
                        <p class="text-xs text-gray-500" id="user-role"></p>
                    </div>
                    <button id="logout-btn" class="btn bg-gray-100 text-gray-700 hover:bg-gray-200 !p-2"><i data-lucide="log-out" class="h-5 w-5"></i></button>
                </div>
            </div>
        </header>
        <div class="flex flex-grow overflow-hidden relative">
            <aside class="w-64 bg-white p-4 flex-shrink-0 border-r border-gray-200 flex flex-col">
                <nav class="flex flex-col space-y-2 flex-grow">
                    <a class="nav-item" data-page="dashboard"><i data-lucide="layout-dashboard" class="mr-3 h-5 w-5"></i>Dashboard</a>
                    <a class="nav-item" data-page="generate"><i data-lucide="cpu" class="mr-3 h-5 w-5"></i>Generate Timetable</a>
                    <a class="nav-item" data-page="view"><i data-lucide="eye" class="mr-3 h-5 w-5"></i>View Timetable</a>
                </nav>
            </aside>
            <main class="flex-1 p-8 overflow-y-auto">
                <div id="dashboard-page" class="hidden">
                    <h1 class="text-3xl font-bold mb-2">Dashboard</h1>
                    <p class="text-gray-600 mb-8">Overview of the timetable generation system.</p>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="font-semibold text-gray-700">Generation Status</h3>
                            <p class="text-2xl font-bold text-green-600 mt-2">Completed</p>
                            <p class="text-sm text-gray-500">Last run: 2 days ago</p>
                        </div>
                         <div class="card p-6">
                            <h3 class="font-semibold text-gray-700">Total Conflicts Resolved</h3>
                            <p class="text-2xl font-bold text-teal-600 mt-2">1,204</p>
                            <p class="text-sm text-gray-500">by the AI engine</p>
                        </div>
                         <div class="card p-6">
                            <h3 class="font-semibold text-gray-700">Resource Utilization</h3>
                            <p class="text-2xl font-bold text-teal-600 mt-2">92%</p>
                            <p class="text-sm text-gray-500">Faculty & Rooms</p>
                        </div>
                    </div>
                </div>
                <div id="generate-page" class="hidden">
                    <h1 class="text-3xl font-bold mb-4">Generate New Timetable</h1>
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold mb-2">1. Add Subjects, Faculty, and Rooms</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <input id="subject-name" type="text" placeholder="Subject Name" class="border p-2 rounded-md w-full">
                                <input id="faculty-name" type="text" placeholder="Faculty Name" class="border p-2 rounded-md w-full">
                                <input id="subject-hours" type="number" placeholder="Hours/Week" class="border p-2 rounded-md w-full">
                                <input id="room-number" type="text" placeholder="Room No." class="border p-2 rounded-md w-full">
                            </div>
                            <button id="add-subject-btn" class="btn btn-primary">Add Subject</button>
                            <div class="mt-6">
                                <h3 class="font-semibold">Subject List:</h3>
                                <ul id="subject-list" class="space-y-2 mt-2"></ul>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-lg font-semibold mb-2">2. Add Students & Enrollments</h2>
                            <div class="flex items-end space-x-2 mb-4">
                                <input id="student-name" type="text" placeholder="Student Name" class="border p-2 rounded-md w-full">
                                <button id="add-student-btn" class="btn btn-primary">Add Student</button>
                            </div>
                            <div class="mt-6">
                                <h3 class="font-semibold">Student List:</h3>
                                <ul id="student-list" class="space-y-2 mt-2"></ul>
                            </div>
                        </div>
                        <div class="card p-6 text-center">
                            <h2 class="text-lg font-semibold mb-2">3. Generate Schedule</h2>
                            <div id="generate-start">
                                <button id="start-generation-btn" class="btn btn-primary w-full md:w-auto" disabled>
                                    <i data-lucide="play" class="mr-2 h-5 w-5"></i>Generate Timetable
                                </button>
                                <p id="generation-warning" class="text-xs text-red-500 mt-2">Please add at least one subject and one student.</p>
                            </div>
                            <div id="generate-progress" class="hidden w-full max-w-sm mx-auto">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-teal-600 mx-auto"></div>
                                <p id="progress-text" class="text-gray-500 mt-2">Initializing constraints...</p>
                            </div>
                            <div id="generate-complete" class="hidden">
                                <i data-lucide="check-circle-2" class="h-12 w-12 text-green-500 mx-auto"></i>
                                <h3 class="text-xl font-semibold mt-2">Generation Complete!</h3>
                                <p class="text-gray-500">An optimized, conflict-free timetable has been generated.</p>
                                <button class="btn btn-primary mt-4" data-page-link="view">
                                    <i data-lucide="eye" class="mr-2 h-5 w-5"></i>View Timetable
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="view-page" class="hidden">
                    <div id="admin-tools-panel" class="hidden card p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="admin-view-filter">
                                <h3 class="font-semibold mb-2 text-gray-700">Filter Timetable View</h3>
                                <div class="flex items-center space-x-4">
                                   <select id="faculty-filter" class="border p-2 rounded-md w-full"><option value="">-- View by Faculty --</option></select>
                                   <select id="student-filter" class="border p-2 rounded-md w-full"><option value="">-- View by Student --</option></select>
                                   <button id="reset-view-btn" class="btn bg-gray-200 text-gray-700">Master View</button>
                                </div>
                            </div>
                            <div id="admin-impersonation">
                                <h3 class="font-semibold mb-2 text-gray-700">Impersonate Role</h3>
                                <div class="flex items-center space-x-4">
                                    <button id="view-as-teacher-btn" class="btn bg-blue-100 text-blue-700 w-full">View as Teacher</button>
                                    <button id="view-as-student-btn" class="btn bg-blue-100 text-blue-700 w-full">View as Student</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-6"><div><h1 id="timetable-title" class="text-3xl font-bold">Generated Timetable</h1><p class="text-gray-600">FYUP - B.Ed. Semester 1 (2025-26)</p></div><button class="btn btn-primary"><i data-lucide="download" class="mr-2 h-5 w-5"></i>Export (PDF/Excel)</button></div>
                    <div id="timetable-output" class="card p-6 overflow-x-auto"></div>
                </div>
            </main>
            
            <div id="enrollment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-30">
                 <div class="card w-full max-w-lg">
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 id="enrollment-modal-title" class="text-xl font-semibold"></h3>
                        <button id="close-enrollment-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="h-6 w-6"></i></button>
                    </div>
                    <div id="enrollment-modal-body" class="p-6 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                currentUser: null,
                selectedRole: null,
                impersonatingRole: null,
                subjects: [],
                students: [],
                generatedTimetable: null,

                init() {
                    lucide.createIcons();
                    this.setupAuth();
                    this.setupNavigation();
                    this.setupGeneratorPage();
                    this.setupViewFilters();
                    this.setupImpersonation();
                },

                showPage(pageId) {
                    document.querySelectorAll('main > div').forEach(page => page.classList.add('hidden'));
                    const pageToShow = document.getElementById(`${pageId}-page`);
                    if (pageToShow) pageToShow.classList.remove('hidden');
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.page === pageId);
                    });
                },

                setupAuth() {
                    const loginContainer = document.getElementById('login-container');
                    const mainAppContainer = document.getElementById('app');
                    const loginForm = document.getElementById('login-form');
                    const logoutBtn = document.getElementById('logout-btn');
                    const loginError = document.getElementById('login-error');
                    const roleSelectionView = document.getElementById('role-selection-view');
                    const loginFormView = document.getElementById('login-form-view');
                    const roleButtons = document.querySelectorAll('.role-btn');
                    const backToRoleBtn = document.getElementById('back-to-role-btn');
                    const loginTitle = document.getElementById('login-title');

                    roleButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const role = button.dataset.role;
                            this.selectedRole = role;
                            roleSelectionView.classList.add('hidden');
                            loginFormView.classList.remove('hidden');
                            loginTitle.textContent = `${role} Login`;
                            document.getElementById('email').value = `${role.toLowerCase()}@college.edu`;
                        });
                    });

                    backToRoleBtn.addEventListener('click', () => {
                        loginFormView.classList.add('hidden');
                        roleSelectionView.classList.remove('hidden');
                        this.selectedRole = null;
                        loginError.classList.add('hidden');
                    });

                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const expectedEmail = `${this.selectedRole.toLowerCase()}@college.edu`;
                        if (email === expectedEmail && password === 'password') {
                            this.currentUser = { email, role: this.selectedRole };
                            loginContainer.classList.add('hidden');
                            mainAppContainer.classList.remove('hidden');
                            loginError.classList.add('hidden');
                            this.updateUIAfterLogin();
                        } else {
                            loginError.classList.remove('hidden');
                        }
                    });

                    logoutBtn.addEventListener('click', () => {
                        this.currentUser = null;
                        this.selectedRole = null;
                        this.impersonatingRole = null;
                        this.subjects = [];
                        this.students = [];
                        this.generatedTimetable = null;
                        this.renderSubjectList();
                        this.renderStudentList();
                        mainAppContainer.classList.add('hidden');
                        loginContainer.classList.remove('hidden');
                        loginFormView.classList.add('hidden');
                        roleSelectionView.classList.remove('hidden');
                    });
                },

                updateUIAfterLogin() {
                    if (!this.currentUser) return;
                    const displayRole = this.impersonatingRole || this.currentUser.role;
                    
                    document.getElementById('user-email').textContent = this.currentUser.email;
                    document.getElementById('user-role').textContent = this.impersonatingRole ? `${this.currentUser.role} (Viewing as ${this.impersonatingRole})` : this.currentUser.role;
                    
                    const navItems = {
                        dashboard: document.querySelector('[data-page="dashboard"]'),
                        generate: document.querySelector('[data-page="generate"]'),
                        view: document.querySelector('[data-page="view"]'),
                    };
                    Object.values(navItems).forEach(item => item.style.display = 'none');
                    
                    document.getElementById('admin-tools-panel').classList.toggle('hidden', this.currentUser.role !== 'Admin' || this.impersonatingRole !== null);
                    document.getElementById('return-to-admin-container').classList.toggle('hidden', !this.impersonatingRole);

                    switch (displayRole) {
                        case 'Admin':
                            Object.values(navItems).forEach(item => item.style.display = 'flex');
                            if (!this.impersonatingRole) this.showPage('dashboard');
                            else this.showPage('view');
                            break;
                        case 'Teacher':
                            navItems.view.style.display = 'flex';
                            this.displayTimetable(this.generatedTimetable, { type: 'faculty', name: this.subjects[0]?.faculty || 'teacher@college.edu' }); 
                            this.showPage('view');
                            break;
                        case 'Student':
                            navItems.view.style.display = 'flex';
                            this.displayTimetable(this.generatedTimetable, { type: 'student', name: this.students[0]?.name || 'student@college.edu' });
                            this.showPage('view');
                            break;
                    }
                },

                setupNavigation() {
                    document.querySelectorAll('.nav-item, [data-page-link]').forEach(link => {
                        link.addEventListener('click', () => this.showPage(link.dataset.page || link.dataset.pageLink));
                    });
                },

                setupGeneratorPage() {
                    document.getElementById('add-subject-btn').addEventListener('click', () => this.addSubject());
                    document.getElementById('add-student-btn').addEventListener('click', () => this.addStudent());
                    document.getElementById('start-generation-btn').addEventListener('click', () => this.startGeneration());
                    document.getElementById('close-enrollment-modal-btn').addEventListener('click', () => {
                        document.getElementById('enrollment-modal').classList.add('hidden');
                    });
                },
                
                addSubject() {
                    const name = document.getElementById('subject-name').value.trim();
                    const faculty = document.getElementById('faculty-name').value.trim();
                    const hours = parseInt(document.getElementById('subject-hours').value, 10);
                    const room = document.getElementById('room-number').value.trim();

                    if (!name || !faculty || !hours || !room) { alert('Please fill in all fields.'); return; }
                    if (this.subjects.some(sub => sub.name.toLowerCase() === name.toLowerCase())) { alert('Subject already added!'); return; }
                    this.subjects.push({ name, faculty, hours, room, students: [] });
                    this.renderSubjectList();
                    ['subject-name', 'faculty-name', 'subject-hours', 'room-number'].forEach(id => document.getElementById(id).value = '');
                },

                renderSubjectList() {
                    const list = document.getElementById('subject-list');
                    list.innerHTML = '';
                    this.subjects.forEach((sub, index) => {
                        const li = document.createElement('li');
                        li.className = "p-2 border rounded-md flex justify-between items-center";
                        li.innerHTML = `<span>${sub.name} (${sub.faculty}) - ${sub.hours} hrs - Room ${sub.room}</span><button data-index="${index}" class="remove-subject-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`;
                        list.appendChild(li);
                    });
                    lucide.createIcons();
                    document.querySelectorAll('.remove-subject-btn').forEach(btn => btn.addEventListener('click', (e) => this.removeSubject(e.currentTarget.dataset.index)));
                    this.checkGenerationReadiness();
                },

                removeSubject(index) {
                    this.subjects.splice(index, 1);
                    this.renderSubjectList();
                },

                addStudent() {
                    const name = document.getElementById('student-name').value.trim();
                    if(!name) { alert("Please enter a student name."); return; }
                    if(this.students.some(s => s.name.toLowerCase() === name.toLowerCase())) { alert("Student already exists."); return; }
                    this.students.push({ name, enrollments: [] });
                    this.renderStudentList();
                    document.getElementById('student-name').value = '';
                },

                renderStudentList() {
                    const list = document.getElementById('student-list');
                    list.innerHTML = '';
                    this.students.forEach((student, index) => {
                        const li = document.createElement('li');
                        li.className = "p-2 border rounded-md flex justify-between items-center";
                        li.innerHTML = `<span>${student.name} (${student.enrollments.length} courses)</span><div class="space-x-2"><button data-index="${index}" class="enroll-student-btn text-blue-500 hover:text-blue-700">Manage Enrollments</button><button data-index="${index}" class="remove-student-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`;
                        list.appendChild(li);
                    });
                    lucide.createIcons();
                    document.querySelectorAll('.remove-student-btn').forEach(btn => btn.addEventListener('click', (e) => this.removeStudent(e.currentTarget.dataset.index)));
                    document.querySelectorAll('.enroll-student-btn').forEach(btn => btn.addEventListener('click', (e) => this.openEnrollmentModal(e.currentTarget.dataset.index)));
                    this.checkGenerationReadiness();
                },

                removeStudent(index) {
                    this.students.splice(index, 1);
                    this.renderStudentList();
                },

                openEnrollmentModal(studentIndex) {
                    const student = this.students[studentIndex];
                    document.getElementById('enrollment-modal-title').textContent = `Enroll ${student.name} in Courses`;
                    const body = document.getElementById('enrollment-modal-body');
                    body.innerHTML = '';
                    this.subjects.forEach(subject => {
                        const isEnrolled = student.enrollments.includes(subject.name);
                        body.innerHTML += `
                            <label class="flex items-center space-x-2 p-2 rounded hover:bg-gray-100">
                                <input type="checkbox" data-student-index="${studentIndex}" data-subject-name="${subject.name}" class="enrollment-checkbox h-4 w-4" ${isEnrolled ? 'checked' : ''}>
                                <span>${subject.name}</span>
                            </label>
                        `;
                    });
                    document.getElementById('enrollment-modal').classList.remove('hidden');
                    document.querySelectorAll('.enrollment-checkbox').forEach(box => box.addEventListener('change', (e) => {
                        this.updateEnrollment(e.target.dataset.studentIndex, e.target.dataset.subjectName, e.target.checked);
                    }));
                },
                
                updateEnrollment(studentIndex, subjectName, isEnrolled) {
                    const student = this.students[studentIndex];
                    if (isEnrolled) {
                        if (!student.enrollments.includes(subjectName)) student.enrollments.push(subjectName);
                    } else {
                        student.enrollments = student.enrollments.filter(s => s !== subjectName);
                    }
                    this.renderStudentList();
                },

                checkGenerationReadiness() {
                    const ready = this.subjects.length > 0 && this.students.length > 0;
                    document.getElementById('start-generation-btn').disabled = !ready;
                    document.getElementById('generation-warning').classList.toggle('hidden', ready);
                },

                startGeneration() {
                    document.getElementById('generate-start').classList.add('hidden');
                    document.getElementById('generate-progress').classList.remove('hidden');
                    document.getElementById('generate-complete').classList.add('hidden');
                    setTimeout(() => {
                        this.runGeneratorAlgorithm();
                        document.getElementById('generate-progress').classList.add('hidden');
                        document.getElementById('generate-complete').classList.remove('hidden');
                    }, 1500);
                },

                runGeneratorAlgorithm() {
                    // ... same algorithm as before
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                    const slots = ['9-10 AM', '10-11 AM', '11-12 PM', '1-2 PM', '2-3 PM', "3-4 PM"];
                    let timetable = {}; days.forEach(day => { timetable[day] = {}; slots.forEach(slot => timetable[day][slot] = null); });
                    let facultySchedule = {}; let roomSchedule = {};
                    const classesToSchedule = [];
                    this.subjects.forEach(sub => {
                        for(let i=0; i < sub.hours; i++) {
                            const enrolledStudents = this.students.filter(s => s.enrollments.includes(sub.name)).map(s => s.name);
                            classesToSchedule.push({...sub, students: enrolledStudents });
                        }
                        if (!facultySchedule[sub.faculty]) facultySchedule[sub.faculty] = {};
                        if (!roomSchedule[sub.room]) roomSchedule[sub.room] = {};
                    });
                    
                    classesToSchedule.sort(() => 0.5 - Math.random());

                    for (const classToPlace of classesToSchedule) {
                        let placed = false;
                        for (const day of days) { for (const slot of slots) {
                                const slotKey = `${day}-${slot}`;
                                if (!timetable[day][slot] && !facultySchedule[classToPlace.faculty][slotKey] && !roomSchedule[classToPlace.room][slotKey]) {
                                    timetable[day][slot] = classToPlace;
                                    facultySchedule[classToPlace.faculty][slotKey] = true;
                                    roomSchedule[classToPlace.room][slotKey] = true;
                                    placed = true; break;
                                }
                            } if (placed) break;
                        }
                    }
                    this.generatedTimetable = timetable;
                    this.populateFilters();
                    this.displayTimetable(timetable);
                },

                displayTimetable(timetable, filter = null) {
                    if (!timetable) {
                        document.getElementById('timetable-output').innerHTML = `<p class="text-center text-gray-500">No timetable has been generated yet.</p>`;
                        return;
                    }

                    const output = document.getElementById('timetable-output');
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                    const slotHeadersWithLunch = ['9-10 AM', '10-11 AM', '11-12 PM', '12-1 PM', '1-2 PM', '2-3 PM', "3-4 PM"];
                    output.innerHTML = '';
                    let header = `<div class="grid grid-cols-8 gap-2 text-center font-semibold mb-2"><div></div>`;
                    slotHeadersWithLunch.forEach(slot => header += `<div>${slot}</div>`);
                    header += '</div>';
                    output.innerHTML += header;

                    days.forEach(day => {
                        let row = `<div class="grid grid-cols-8 gap-2 mt-2"><div class="font-semibold my-auto">${day}</div>`;
                        slotHeadersWithLunch.forEach(slot => {
                            if (slot === '12-1 PM') { 
                                row += `<div class="bg-gray-100 p-2 rounded-md flex items-center justify-center text-gray-400">LUNCH</div>`;
                            } else {
                                const cellData = timetable[day][slot];
                                let isVisible = !filter;
                                if(filter && cellData) {
                                    if(filter.type === 'faculty' && cellData.faculty === filter.name) isVisible = true;
                                    if(filter.type === 'student' && cellData.students.includes(filter.name)) isVisible = true;
                                }

                                if (cellData && isVisible) {
                                    const { name, faculty, room } = cellData;
                                    row += `<div class="timetable-slot">${name}<br><small>${faculty} (${room})</small></div>`;
                                } else {
                                    row += `<div class="timetable-slot bg-gray-50 border-gray-200 ${filter ? 'faded' : ''}"></div>`;
                                }
                            }
                        });
                        row += '</div>';
                        output.innerHTML += row;
                    });
                },

                populateFilters() {
                    const facultyFilter = document.getElementById('faculty-filter');
                    const studentFilter = document.getElementById('student-filter');
                    facultyFilter.innerHTML = '<option value="">-- View by Faculty --</option>';
                    studentFilter.innerHTML = '<option value="">-- View by Student --</option>';

                    const uniqueFaculty = [...new Set(this.subjects.map(s => s.faculty))];
                    uniqueFaculty.forEach(f => facultyFilter.innerHTML += `<option value="${f}">${f}</option>`);
                    
                    this.students.forEach(s => studentFilter.innerHTML += `<option value="${s.name}">${s.name}</option>`);
                },

                setupViewFilters() {
                    const facultyFilter = document.getElementById('faculty-filter');
                    const studentFilter = document.getElementById('student-filter');
                    const resetBtn = document.getElementById('reset-view-btn');

                    facultyFilter.addEventListener('change', () => {
                        studentFilter.value = "";
                        const name = facultyFilter.value;
                        document.getElementById('timetable-title').textContent = name ? `${name}'s Timetable` : 'Master Timetable';
                        this.displayTimetable(this.generatedTimetable, name ? { type: 'faculty', name } : null);
                    });
                    
                    studentFilter.addEventListener('change', () => {
                        facultyFilter.value = "";
                        const name = studentFilter.value;
                        document.getElementById('timetable-title').textContent = name ? `${name}'s Timetable` : 'Master Timetable';
                        this.displayTimetable(this.generatedTimetable, name ? { type: 'student', name } : null);
                    });

                    resetBtn.addEventListener('click', () => {
                        facultyFilter.value = "";
                        studentFilter.value = "";
                        document.getElementById('timetable-title').textContent = 'Generated Timetable';
                        this.displayTimetable(this.generatedTimetable, null);
                    });
                },
                
                setupImpersonation() {
                    document.getElementById('view-as-teacher-btn').addEventListener('click', () => {
                        this.impersonatingRole = 'Teacher';
                        this.updateUIAfterLogin();
                    });
                     document.getElementById('view-as-student-btn').addEventListener('click', () => {
                        this.impersonatingRole = 'Student';
                        this.updateUIAfterLogin();
                    });
                     document.getElementById('return-to-admin-btn').addEventListener('click', () => {
                        this.impersonatingRole = null;
                        this.updateUIAfterLogin();
                        this.showPage('view');
                    });
                }
            };
            app.init();
        });
    </script>
</body>
</html>




